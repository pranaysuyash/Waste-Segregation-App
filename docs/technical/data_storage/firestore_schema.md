# Firestore Schema

This document outlines the collections and data structures used in Firebase Firestore.

## 1. Users (`users`)

*   **Document ID**: `userId` (same as Firebase Auth UID)
*   **Data**:
    *   `uid`: String (Firebase Auth UID)
    *   `email`: String
    *   `displayName`: String
    *   `photoUrl`: String?
    *   `createdAt`: Timestamp
    *   `lastLogin`: Timestamp
    *   `userGamificationProfile`: Map (schema defined by `GamificationProfile.toJson()` from `lib/models/gamification.dart`)
        *   `points`: Map (schema from `UserPoints.toJson()`)
            *   `total`: int
            *   `weeklyTotal`: int
            *   `monthlyTotal`: int
            *   `level`: int
            *   `categoryPoints`: Map<String, int>
        *   `achievements`: List<Map> (schema from `Achievement.toJson()`)
        *   `activeChallenges`: List<Map> (schema from `Challenge.toJson()`)
        *   `completedChallenges`: List<Map> (schema from `Challenge.toJson()`)
        *   `preferences`: Map (schema from `UserPreferences.toJson()`)
        *   `dailyStreak`: Map (schema from `DailyStreak.toJson()`)
    *   `userSettings`: Map (schema defined by `UserSettings.toJson()` from `lib/models/user_settings.dart`)
    *   `familyId`: String? (ID of the family the user belongs to)

## 2. Classifications (`classifications`)

*   **Subcollection of**: `users/{userId}/classifications`
*   **Document ID**: Auto-generated by Firestore or `WasteClassification.id`
*   **Data**: Schema defined by `WasteClassification.toJson()` from `lib/models/waste_classification.dart`
    *   ... (key fields include `itemName`, `category`, `accuracy`, `timestamp`, `imageUrl`, `feedback`, `reanalysisModelsTried`, `confirmedByModel`, etc.)

## 3. Community Feed (`community_feed`)

*   **Document ID**: Auto-generated
*   **Data**: Schema defined by `CommunityFeedItem.toJson()` from `lib/models/community_feed.dart`
    *   ... (key fields include `userId`, `userName`, `userPhotoUrl`, `type`, `message`, `relatedItemId`, `timestamp`, `likes`, `comments`, `achievementId`, `challengeId`, etc.)

## 4. Families (`families`)

*   **Document ID**: Auto-generated
*   **Data**:
    *   `familyName`: String
    *   `familyAdminUids`: List<String> (UIDs of family admins)
    *   `memberUids`: List<String> (UIDs of family members)
    *   `createdAt`: Timestamp
    *   `familyCode`: String (invite code)
    *   `familyGoals`: List<Map> (shared family goals)
    *   `familyLeaderboardSettings`: Map (settings for family-specific leaderboards)

## 5. All-Time Leaderboard (`leaderboard_allTime`)

This collection stores entries for the global all-time leaderboard. Entries are updated when a user's total points change.

*   **Document ID**: `userId` (same as Firebase Auth UID)
*   **Data** (derived from `LeaderboardEntry` in `lib/models/leaderboard.dart` and `UserPoints` in `lib/models/gamification.dart`):
    *   `userId`: String (Firebase Auth UID)
    *   `displayName`: String (User's display name, denormalized for quick reads)
    *   `photoUrl`: String? (User's photo URL, denormalized)
    *   `points`: int (Corresponds to `UserPoints.total`)
    *   `rank`: int? (Optional, can be calculated on read or by a periodic function for large leaderboards. For smaller ones, client-side sorting might be feasible.)
    *   `categoryBreakdown`: Map<String, int> (from `UserPoints.categoryPoints`, if desired on leaderboard)
    *   `stats`: Map? (Optional, could store `UserLeaderboardStats.toJson()` if detailed stats are needed directly on the leaderboard entry. Initially, points might be sufficient.)
    *   `lastUpdated`: Timestamp (When this leaderboard entry was last updated)

**Note on Ranks**: Calculating and storing ranks directly in documents can be complex for real-time updates in a large system. For an initial implementation, ranks can be determined by fetching the top N entries ordered by `points` and assigning ranks on the client-side. For very large leaderboards, a more sophisticated solution (e.g., periodic Cloud Function, specialized backend) might be needed.

## Extensible Firestore Schema for Multi-Type Leaderboards

To support multiple leaderboard types (period-based, metric-based, category, group, etc.), the schema should be extensible and efficient for querying.

### Collection Naming
- Use a base collection (e.g., `leaderboards`) with documents for each leaderboard type/period/metric, or
- Use composite collection names (e.g., `leaderboard_{period}_{metric}`) for fast access.

### Example Document Structure
```json
{
  "userId": "abc123",
  "displayName": "Jane Doe",
  "photoUrl": "https://...",
  "points": 1234,
  "analyses": 567,
  "categoryBreakdown": {
    "Plastic": 200,
    "Food Waste": 150
  },
  "streak": 12,
  "achievements": 8,
  "period": "2024-06", // e.g., YYYY-MM for monthly
  "leaderboardType": "monthly_points", // e.g., daily_points, weekly_analyses, allTime_streak
  "category": "Plastic", // For category-specific leaderboards
  "groupId": "family_789", // For group/family/team leaderboards
  "region": "Bangalore", // For regional leaderboards
  "lastUpdated": "2024-06-15T12:34:56Z"
}
```

### Key Fields
- `userId`: Unique user identifier
- `displayName`, `photoUrl`: Denormalized for fast display
- `points`, `analyses`, `streak`, `achievements`: Metrics for ranking
- `categoryBreakdown`: Map for category-specific leaderboards
- `period`: Leaderboard period (e.g., day, week, month, allTime)
- `leaderboardType`: Composite key for type/period/metric
- `category`: Waste type/category (if applicable)
- `groupId`, `region`: For group/regional leaderboards
- `lastUpdated`: Timestamp for sync/archival

### Indexing & Querying
- Index on `leaderboardType`, `period`, `category`, `groupId`, `region` for efficient queries
- Use compound indexes for common leaderboard queries (e.g., top N by points in a period/category)

### Archival & Reset
- Periodic leaderboards (daily, weekly, monthly) should be archived and reset via Cloud Functions or scheduled jobs
- All-time leaderboards are cumulative

### Privacy
- Only display non-sensitive fields (displayName, photoUrl, rank, points)
- Allow opt-out or anonymized display

---

This schema supports flexible, scalable leaderboard features for future expansion.

*Further collections and schema details will be added as features are developed.* 